<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>센서 리포트</title>

  <!-- Layout 공통 -->
  <link rel="stylesheet" th:href="@{/css/layout.css}">
  <link rel="stylesheet" th:href="@{/css/sensor/report.css}">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- 컨텍스트 패스 -->
  <script th:inline="javascript">
    window.ctx = /*[[@{/}]]*/ "/";
  </script>

  <!-- Report JS -->
  <script th:src="@{/js/report.js}"></script>
</head>

<body>

<!-- HEADER -->
<div th:replace="~{include/header :: header}"></div>

<main class="report-root">

  <!-- 상단 타이틀 & 필터 -->
  <section class="report-topbar">
    <div class="report-topbar-left">
      <div class="report-title-row">
        <h1 class="report-title">센서 리포트</h1>
        <!-- BAD / EVENT 개념 안내 버튼 -->
        <button type="button"
                id="badEventInfoBtn"
                class="info-btn has-tooltip"
                data-tooltip="BAD / EVENT 개념 설명을 확인합니다.">
          ❓ BAD / EVENT 안내
        </button>
      </div>
      <p class="report-subtitle" id="reportSubtitle">데이터 기간: -</p>
      <p class="report-hint">
        HISTORY MODE에서는 이벤트/로그를 지원하지 않습니다.<br>
        기간별 이벤트 구간 및 로그는 이 리포트 화면에서 확인해주세요.
      </p>
    </div>

    <!-- 필터: 카드형 입력폼 -->
    <div class="report-filter">
      <div class="filter-item">
        <label for="yearSelect">연도</label>
        <input type="number" id="yearSelect" min="2020" max="2100" value="2025">
      </div>

      <div class="filter-item">
        <label for="monthSelect">월</label>
        <input type="number" id="monthSelect" min="1" max="12" value="2">
      </div>

      <div class="filter-item">
        <label for="deviceSelect">디바이스</label>
        <select id="deviceSelect">
          <option value="ENV_V2_1">ENV_V2_1</option>
          <option value="ENV_V2_2">ENV_V2_2</option>
          <option value="ENV_V2_3">ENV_V2_3</option>
          <option value="ENV_V2_4">ENV_V2_4</option>
        </select>
      </div>

      <button id="loadReportBtn" type="button" class="filter-btn">
        리포트 조회
      </button>

      <button id="loadCsvBtn" type="button" class="filter-btn"
              style="background:#4a6cf7; color:white;">
        CSV 로드
      </button>
    </div>
  </section>

  <!-- ===================== 메인 리포트 영역 ===================== -->
  <section class="report-main">

    <!-- 왼쪽 : 월별 테이블 + 월별 그래프 -->
    <div class="panel panel-left">
      <div class="panel-header">
        <h2>월별 센서 요약</h2>
      </div>

      <!-- 월별 그래프 -->
      <div class="monthly-chart-area">
        <div class="panel-header panel-header-sub">
          <h3 class="chart-title-row">
            <span>월별 평균 + 이벤트 그래프</span>
            <span class="chart-info has-tooltip"
                  data-tooltip="막대: 센서별 월 평균값 · 라인: 이벤트 구간 수">
              ⓘ
            </span>
          </h3>
        </div>
        <p class="chart-caption" id="chartCaption">센서별 평균값 + 이벤트 수</p>
        <div class="chart-box">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <!-- 월별 테이블 -->
      <div class="table-wrapper">
        <table class="report-table" id="monthlyTable">
          <thead>
          <tr>
            <th data-col-key="index"
                data-col-type="number">
              번호
            </th>
            <th data-col-key="label"
                data-col-type="text"
                class="has-tooltip"
                data-tooltip="센서 유형 (예: 온도, 습도, CO₂ 등)">
              센서
            </th>
            <th data-col-key="min"
                data-col-type="number"
                class="has-tooltip"
                data-tooltip="선택한 월 동안의 최소 측정값">
              최솟값
            </th>
            <th data-col-key="avg"
                data-col-type="number"
                class="has-tooltip"
                data-tooltip="선택한 월 동안의 평균 측정값">
              평균값
            </th>
            <th data-col-key="max"
                data-col-type="number"
                class="has-tooltip"
                data-tooltip="선택한 월 동안의 최대 측정값">
              최댓값
            </th>
            <th data-col-key="badRate"
                data-col-type="number"
                class="has-tooltip"
                data-tooltip="BAD% = 임계값(Threshold)을 벗어난 샘플 비율">
              BAD%
            </th>
            <th data-col-key="event"
                data-col-type="number"
                class="has-tooltip"
                data-tooltip="EVENT = BAD 상태가 하나의 연속 구간으로 묶인 개수">
              Event
            </th>
            <th data-col-key="sample"
                data-col-type="number"
                class="has-tooltip"
                data-tooltip="해당 센서의 전체 샘플 개수">
              샘플 수
            </th>
          </tr>
          </thead>
          <tbody id="monthlyStatsBody"></tbody>
        </table>
        <p class="table-hint">
          💡 <span class="has-tooltip" data-tooltip="BAD%는 임계값을 벗어난 샘플 비율, Event는 BAD 구간 개수를 의미합니다.">
              BAD / Event 차이
             </span> 를 참고해서 센서 상태를 판단하세요.<br>
          💡 <strong>Event</strong> 컬럼을 클릭하면, 해당 센서의 월/주별 이벤트 로그를 새 창에서 확인할 수 있습니다.
        </p>
      </div>

    </div>

    <!-- 오른쪽 : 주차별 탭 + 주차별 그래프 + 주차별 테이블 -->
    <div class="panel panel-right panel-weekly">
      <div class="panel-header">
        <h2>주차별 센서 요약</h2>
      </div>

      <!-- 주차 탭 -->
      <div class="week-tabs" id="weekTabs"></div>

      <!-- 주차별 그래프 -->
      <div class="weekly-chart-area">
        <canvas id="weeklyChart"></canvas>
      </div>

      <!-- 주차별 테이블 -->
      <div class="table-wrapper weekly-table-wrapper" id="weeklyTableWrapper">
        <!-- JS에서 <table class="report-table">로 렌더링 -->
      </div>
    </div>

  </section>

</main>

<!-- BAD / EVENT 개념 설명 모달 -->
<div id="badEventModal" class="info-modal-backdrop">
  <div class="info-modal-panel" role="dialog" aria-modal="true" aria-labelledby="badEventModalTitle">
    <div class="info-modal-header">
      <h2 id="badEventModalTitle">BAD / EVENT 개념 안내</h2>
      <button type="button" class="info-modal-close" id="badEventModalClose" aria-label="닫기">
        &times;
      </button>
    </div>
    <div class="info-modal-body">
      <section class="info-section">
        <h3>BAD (임계값 초과 상태)</h3>
        <p>
          센서값이 <strong>Threshold 범위(min ~ max)를 벗어난 경우</strong> BAD로 판정합니다.
        </p>
        <ul>
          <li>BAD% = BAD로 판정된 샘플 수 ÷ 전체 샘플 수 × 100</li>
          <li>BAD%는 <strong>문제 상태였던 시간 비중</strong>을 의미합니다.</li>
        </ul>
      </section>

      <section class="info-section">
        <h3>EVENT (BAD 구간 개수)</h3>
        <p>
          연속된 BAD 상태를 <strong>하나의 이벤트</strong>로 계산합니다.
        </p>
        <pre class="info-code">
GOOD → BAD → BAD → BAD → GOOD
        </pre>
        <ul>
          <li>위 예시는 BAD 샘플은 3번이지만, EVENT는 1개입니다.</li>
          <li>EVENT는 <strong>문제 상태가 몇 번 발생했는지(빈도)</strong>를 의미합니다.</li>
        </ul>
      </section>

      <section class="info-section">
        <h3>BAD vs EVENT 한눈에 보기</h3>
        <table class="info-summary-table">
          <thead>
          <tr>
            <th>항목</th>
            <th>의미</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td>BAD%</td>
            <td>임계값을 벗어난 상태였던 <strong>시간 비중</strong></td>
          </tr>
          <tr>
            <td>EVENT</td>
            <td>문제 상태가 <strong>몇 번 발생했는지(빈도)</strong></td>
          </tr>
          </tbody>
        </table>
      </section>

      <section class="info-section">
        <h3>BAD% 색상 기준 (산업용 모니터링 스타일)</h3>
        <ul>
          <li><span class="legend-dot legend-good"></span> GOOD : 0 ~ 10%</li>
          <li><span class="legend-dot legend-warn"></span> WARN : 10 ~ 30%</li>
          <li><span class="legend-dot legend-bad"></span> BAD : 30% 이상</li>
        </ul>
      </section>
    </div>
    <div class="info-modal-footer">
      <button type="button" class="filter-btn info-modal-ok-btn" id="badEventModalOk">
        확인
      </button>
    </div>
  </div>
</div>

<!-- 글로벌 로딩 스피너 -->
<div id="loadingOverlay" class="loading-overlay" style="display:none;">
  <div class="spinner"></div>
  <p>데이터 로딩 중...</p>
</div>

<!-- FOOTER -->
<div th:replace="~{include/footer :: footer}"></div>

</body>
</html>
