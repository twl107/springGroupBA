<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

  <meta charset="UTF-8">
  <title>그린소프트 - 센서 안내</title>

  <script th:inline="javascript">
    /*<![CDATA[*/
    window.contextPath = /*[[@{/}]]*/ "/";
    /*]]>*/
  </script>

  <link rel="stylesheet" th:href="@{/css/layout.css}">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* =============================
          SUB VISUAL (상단 Hero)
       ============================= */
    .sub-visual.sensor-visual {
      width: 100%;
      height: 260px;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      background-color: rgba(0,0,0,0.45);
      background-blend-mode: darken;
    }

    .sub-visual.sensor-visual h2 {
      font-size: 34px;
      font-weight: 700;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .sub-visual.sensor-visual p {
      font-size: 16px;
      opacity: 0.92;
    }

    /* =============================
            CONTENT WRAPPER
       ============================= */
    .sensor-inner {
      width: 90%;
      max-width: 1100px;
      margin: 0 auto 60px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin-top: 40px;
      margin-bottom: 8px;
    }

    .section-intro {
      text-align: center;
      color: #666;
      margin-bottom: 32px;
      line-height: 1.6;
      font-size: 15px;
    }

    /* =============================
            SENSOR CARD GRID
       ============================= */
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 26px;
    }

    .sensor-card {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7ee;
      padding: 20px 24px 22px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      transition: 0.25s ease;
      position: relative;
    }

    .sensor-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    .sensor-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .sensor-model {
      font-size: 13px;
      color: #777;
      margin-bottom: 10px;
    }

    .sensor-desc {
      font-size: 14px;
      color: #444;
      line-height: 1.55;
      margin-bottom: 14px;
    }

    .qr-box {
      text-align: left;
      margin-top: 10px;
    }

    .qr-box canvas {
      width: 110px !important;
      height: 110px !important;
      background: #fff;
      padding: 4px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    /* 관리자 버튼 */
    .admin-btns {
      margin-top: 10px;
    }
  </style>

</head>

<body>
<div th:replace="~{include/header :: header}"></div>

<main class="main-content">

  <!-- 상단 Hero -->
  <section class="sub-visual sensor-visual"
           th:style="'background-image: url(' + @{/images/content/img_visual_review.jpg} + ');'">
    <div>
      <h2>SENSOR GUIDE</h2>
      <p>그린소프트 솔루션에서 사용되는 주요 센서들을 안내합니다.</p>
    </div>
  </section>

  <div class="sensor-inner">

    <h3 class="section-title">센서 목록</h3>
    <p class="section-intro">
      현재 시스템에 적용된 센서와 해당 센서의 측정 기능, 상세 문서에 대한 정보를 제공합니다.<br>
      QR 코드를 통해 현장에서도 빠르게 접근할 수 있습니다.
    </p>

    <!-- 관리자 버튼 -->
    <button th:if="${isAdmin}"
            class="btn btn-primary"
            th:onclick="|location.href='@{/sensor/add}'|">
      센서 추가
    </button>

    <!-- SENSOR GRID -->
    <div class="sensor-grid">
      <div class="sensor-card" th:each="s : ${sensorList}">

        <!-- SENSOR IMAGE -->
        <div class="sensor-img-box"
             style="width:100%; height:180px; overflow:hidden; border-radius:12px; margin-bottom:14px;">
          <!-- 이미지 있을 때 -->
          <img th:if="${s.imageUrl != null}"
               th:src="@{${s.imageUrl}}"
               style="width:100%; height:100%; object-fit:cover;"
               th:onerror="|this.src='@{/images/noimage.jpg}'|">
        </div>

        <div class="sensor-title" th:text="${s.name}"></div>
        <div class="sensor-model" th:text="'모델명 : ' + ${s.model}"></div>

        <p class="sensor-desc" th:text="${s.summary}"></p>
        <p class="sensor-desc" th:text="${s.description}"></p>

        <div class="qr-box">
          <canvas th:id="'qr-' + ${s.code}"></canvas>
        </div>

        <!-- 관리자 버튼 -->
        <div th:if="${isAdmin}" class="admin-btns">

          <!-- EDIT 페이지 이동 -->
          <button class="btn btn-sm btn-outline-secondary"
                  th:onclick="|location.href='@{/sensor/edit/{id}(id=${s.id})}'|">
            수정
          </button>

          <button class="btn btn-sm btn-outline-danger"
                  th:onclick="|deleteSensor(${s.id})|">
            삭제
          </button>
        </div>

      </div>
    </div>
  </div>
</main>

<div th:replace="~{include/footer :: footer}"></div>

<!-- Toast 알림 -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toastBox" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        삭제되었습니다.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- QR SCRIPT -->
<script>
  document.addEventListener("DOMContentLoaded", function () {

    document.querySelectorAll("canvas[id^='qr-']").forEach(canvas => {
      const code = canvas.id.replace("qr-", "");
      const url =
        location.origin +
        contextPath +
        "sensor/detail/" +
        encodeURIComponent(code);

      QRCode.toCanvas(canvas, url, { width: 120 });
    });

  });

  function deleteSensor(id) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    fetch(contextPath + "api/sensor-meta/delete/" + id, {
      method: "POST"
    })
    .then(res => {
      if (res.ok) {
        alert("삭제 완료");
        location.reload();
      } else {
        alert("삭제 실패 : " + res.status);
      }
    });
  }
</script>


</body>
</html>
