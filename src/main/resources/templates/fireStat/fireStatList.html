<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì†Œë°©ì²­ í™”ì¬ í†µê³„ ì¡°íšŒ</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/fireStat.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<div th:replace="~{include/header :: header}"></div>
<section class="sub-visual" th:style="'background-image: url(' + @{/images/content/img_visual01.jpg} + ');'">
    <div class="sub-visual-content">
        <h2>ì†Œë°©ì²­ í™”ì¬ í†µê³„</h2>
        <p>ë¹…ë°ì´í„° ê¸°ë°˜ ì „êµ­ í™”ì¬ í˜„í™© ë¶„ì„</p>
    </div>
</section>
<main class="main-content">
    <div class="sub-content-container">
        <div class="top-nav">
            <a th:href="@{/fireStat/fireStatList}" class="btn-back">â†º ê²€ìƒ‰ ì´ˆê¸°í™”</a>
        </div>
        <div class="search-box">
            <form th:action="@{/fireStat/search}" method="post" onsubmit="showLoading()">
                <label for="year">ğŸ“… ì¡°íšŒ ì—°ë„</label>
                <select name="year" id="year">
                    <option value="2024" th:selected="${selectedYear == 2024}">2024ë…„</option>
                    <option value="2023" th:selected="${selectedYear == 2023}">2023ë…„</option>
                    <option value="2022" th:selected="${selectedYear == 2022}">2022ë…„</option>
                    <option value="2021" th:selected="${selectedYear == 2021}">2021ë…„</option>
                    <option value="2020" th:selected="${selectedYear == 2020}">2020ë…„</option>
                </select>
                <button type="submit" class="btn-search">API ë°ì´í„° ë¶„ì„ ì¡°íšŒ ğŸ”</button>
            </form>
            <div id="loadingMsg" style="display:none;">
                <span class="spinner"></span>
                <span>ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</span>
                <span class="spinner"></span>
            </div>
        </div>
        <div th:if="${stats != null and !stats.isEmpty()}">
            <div style="text-align: center;">
                <h2 class="result-title" th:text="|${selectedYear}ë…„ë„ ì „êµ­ í™”ì¬ í˜„í™©|"></h2>
            </div>
            <div class="summary-card">
                <div class="card">
                    <h3>ì´ í™”ì¬ ê±´ìˆ˜</h3>
                    <p th:text="${#numbers.formatInteger(totalFireCount, 0, 'COMMA') + ' ê±´'}">0 ê±´</p>
                </div>
                <div class="card blue">
                    <h3>ì´ ì¸ëª… í”¼í•´</h3>
                    <p th:text="${#numbers.formatInteger(totalCasualtyCount, 0, 'COMMA') + ' ëª…'}">0 ëª…</p>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="fireChart"></canvas>
            </div>
            <table class="fire-table">
                <thead>
                <tr>
                    <th style="width:10%">ë²ˆí˜¸</th>
                    <th>ì§€ì—­</th>
                    <th>í™”ì¬ ê±´ìˆ˜</th>
                    <th>ì¸ëª… í”¼í•´</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="stat, iter : ${stats}">
                    <td th:text="${iter.count}">1</td>
                    <td th:text="${stat.location}" style="font-weight:bold;">ì„œìš¸</td>
                    <td th:text="${#numbers.formatInteger(stat.fireCount, 0, 'COMMA') + 'ê±´'}">100ê±´</td>
                    <td th:text="${#numbers.formatInteger(stat.casualtyCount, 0, 'COMMA') + 'ëª…'}" style="color:#e74c3c; font-weight:bold;">10ëª…</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${stats != null and stats.isEmpty()}" class="no-data-msg">
            <h3>í•´ë‹¹ ì—°ë„ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>
        </div>
    </div>
</main>

<div th:replace="~{include/footer :: footer}"></div>
<script th:inline="javascript">
    function showLoading() {
        document.getElementById('loadingMsg').style.display = 'flex';

        const btn = document.querySelector('.btn-search');
        btn.disabled = true;
        btn.innerText = "ë¶„ì„ ì¤‘...";
        btn.style.backgroundColor = "#ccc";
    }

    const fireStats = [[${stats}]];

    if (fireStats && fireStats.length > 0) {
        const labels = fireStats.map(s => s.location);
        const fireCounts = fireStats.map(s => s.fireCount);
        const casualtyCounts = fireStats.map(s => s.casualtyCount);
        const ctx = document.getElementById('fireChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'í™”ì¬ ê±´ìˆ˜',
                        data: fireCounts,
                        backgroundColor: 'rgba(255, 107, 107, 0.6)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                        order: 2
                    },
                    {
                        label: 'ì¸ëª… í”¼í•´',
                        data: casualtyCounts,
                        type: 'line',
                        borderColor: 'rgba(83, 82, 237, 1)',
                        backgroundColor: 'rgba(83, 82, 237, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: 'rgba(83, 82, 237, 1)',
                        pointRadius: 4,
                        tension: 0.3,
                        yAxisID: 'y1',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'ì§€ì—­ë³„ í™”ì¬ ë° ì¸ëª…í”¼í•´ ë¶„í¬' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'í™”ì¬ ê±´ìˆ˜' }
                    },
                    y1: {
                        beginAtZero: true,
                        type: 'linear',
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'ì¸ëª… í”¼í•´ (ëª…)' }
                    }
                }
            }
        });
    }
</script>

</body>
</html>