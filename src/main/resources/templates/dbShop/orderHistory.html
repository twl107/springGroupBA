<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ï£ºÎ¨∏ ÎÇ¥Ïó≠</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <style>
        .history-container { max-width: 1000px; margin: 50px auto; padding: 0 20px; }
        .page-title { font-size: 2rem; font-weight: bold; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; }

        .search-box {
            background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;
            border: 1px solid #eee;
        }
        .search-box select, .search-box input[type="text"], .search-box input[type="date"] {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;
        }
        .btn-search { padding: 8px 20px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-reset { padding: 8px 15px; background: #fff; color: #555; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; font-size: 0.9rem; }

        .order-card { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .order-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .order-date { font-weight: bold; font-size: 1.1rem; }
        .order-status { font-weight: bold; color: #007bff; background: #e7f1ff; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; }

        .delivery-info-box { background-color: #fcfcfc; border-bottom: 1px solid #eee; padding: 15px 20px; font-size: 0.9rem; color: #444; }
        .delivery-row { margin-bottom: 6px; display: flex; align-items: flex-start; }
        .delivery-label { font-weight: bold; color: #333; width: 80px; min-width: 80px; margin-right: 10px; }
        .req-box { background-color: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; display: inline-block; }

        .order-items { padding: 20px; }
        .item-row { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f1f1f1; padding-bottom: 15px; }
        .item-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; border: 1px solid #eee; margin-right: 20px; }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.05rem; margin-bottom: 5px; }
        .product-link { text-decoration: none; color: inherit; cursor: pointer; transition: color 0.2s; }
        .product-link:hover { color: #007bff; text-decoration: underline; }
        .item-price { color: #555; }

        .btn-action { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; text-decoration: none; display: inline-block; }
        .btn-confirm { background: #333; color: white; border-color: #333; }
        .btn-review { background: #007bff; color: white; border-color: #007bff; }
        .btn-cancel-req { background: #dc3545; color: white; border-color: #dc3545; }
        .btn-return-req { background: #ffc107; color: #333; border-color: #ffc107; }
        .btn-modify { border-color: #6c757d; color: #6c757d; }
        .btn-delete { border-color: #dc3545; color: #dc3545; }

        .pagination { display: flex; justify-content: center; margin-top: 40px; list-style: none; padding: 0; gap: 5px; }
        .pagination a { display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; border: 1px solid #eee; border-radius: 4px; text-decoration: none; color: #555; background: #fff; transition: all 0.2s; }
        .pagination a:hover { background: #f1f1f1; }
        .pagination .active a { background: #333; color: white; border-color: #333; font-weight: bold; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; }
        .modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
        .form-textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; margin-bottom: 15px; resize: none; }
        .star-rating { display: flex; gap: 5px; cursor: pointer; margin-bottom: 15px; }
        .star { font-size: 2.5rem; color: #ddd; transition: color 0.2s; line-height: 1; }
        .star.filled { color: #ffd700; }
        .file-box { margin-bottom: 15px; }
        .file-box input { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        #currentImageText { font-size: 0.85rem; color: #007bff; margin-top: 5px; display: none; }
    </style>
</head>
<body>
<div th:replace="~{include/header :: header}"></div>

<main class="main-content">
    <div class="history-container">
        <h2 class="page-title">Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h2>
        <form th:action="@{/order/history}" method="get" class="search-box">
            <select name="status">
                <option value="">Ï†ÑÏ≤¥ ÏÉÅÌÉú</option>
                <option th:each="statusEnum : ${orderStatusList}"
                        th:value="${statusEnum}"
                        th:text="${statusEnum.description}"
                        th:selected="${searchStatus != null and statusEnum.name() == searchStatus.name()}"></option>
            </select>
            <span style="font-weight:500; color:#555;">Í∏∞Í∞Ñ:</span>
            <input type="date" name="startDate" id="startDate" th:value="${startDate}" onchange="checkDateRange()">
            <span>~</span>
            <input type="date" name="endDate" id="endDate" th:value="${endDate}" onchange="checkDateRange()">
            <input type="text" name="keyword" th:value="${pageRequestDTO.keyword}" placeholder="ÏÉÅÌíàÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            <button type="submit" class="btn-search">Í≤ÄÏÉâ</button>
            <a th:href="@{/order/history}" class="btn-reset">Ï¥àÍ∏∞Ìôî</a>
        </form>
        <div th:if="${result.dtoList == null or result.dtoList.isEmpty()}" style="text-align: center; padding: 50px; color: #888;">
            Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.
        </div>
        <div th:if="${result.dtoList != null}" th:each="order : ${result.dtoList}" class="order-card">
            <div class="order-header">
                <div>
                    <span class="order-date" th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'yyyy.MM.dd HH:mm') : ''}"></span>
                    <span style="color:#888; margin-left: 10px;">(Ï£ºÎ¨∏Î≤àÌò∏: [[${order.id}]])</span>
                </div>
                <div>
                    <span class="order-status" th:text="${order.status?.description}" style="margin-right: 10px;">ÏÉÅÌÉú</span>
                    <th:block th:if="${order.status != null}">
                        <form th:if="${#lists.contains({'PAYMENT_COMPLETED', 'PREPARING', 'SHIPPING', 'DELIVERED'}, order.status.name())}"
                              th:action="@{/order/cancelRequest}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="orderId" th:value="${order.id}">
                            <button type="submit" class="btn-action btn-cancel-req" onclick="return confirm('Ï£ºÎ¨∏ Ï∑®ÏÜåÎ•º ÏöîÏ≤≠ÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">Ï∑®ÏÜåÏöîÏ≤≠</button>
                        </form>
                        <form th:if="${order.status.name() == 'DELIVERED'}"
                              th:action="@{/order/confirm}" method="post" style="display:inline; margin-left:5px;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="orderId" th:value="${order.id}">
                            <button type="submit" class="btn-action btn-confirm" onclick="return confirm('Íµ¨Îß§Î•º ÌôïÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">Íµ¨Îß§ÌôïÏ†ï</button>
                        </form>
                        <form th:if="${order.status.name() == 'CONFIRMED'}"
                              th:action="@{/order/returnRequest}" method="post" style="display:inline; margin-left:5px;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="orderId" th:value="${order.id}">
                            <button type="submit" class="btn-action btn-return-req" onclick="return confirm('Î∞òÌíàÏùÑ ÏöîÏ≤≠ÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">Î∞òÌíàÏöîÏ≤≠</button>
                        </form>
                    </th:block>
                </div>
            </div>
            <div class="delivery-info-box">
                <div class="delivery-row">
                    <span class="delivery-label">Î∞õÎäî Î∂Ñ</span>
                    <div class="delivery-content">
                        <span style="font-weight: bold;">[[${order.receiverName}]]</span>
                        <span style="color: #666; margin-left: 5px;">([[${order.receiverPhone}]])</span>
                    </div>
                </div>
                <div class="delivery-row">
                    <span class="delivery-label">Î∞∞ÏÜ°ÏßÄ</span>
                    <div class="delivery-content">
                        [[${order.address}]]
                    </div>
                </div>
                <div class="delivery-row" th:if="${order.deliveryRequest != null and order.deliveryRequest != ''}">
                    <span class="delivery-label">ÏöîÏ≤≠ÏÇ¨Ìï≠</span>
                    <div class="delivery-content">
                        <span class="req-box">üì¢ [[${order.deliveryRequest}]]</span>
                    </div>
                </div>
            </div>
            <div class="order-items">
                <div th:each="item : ${order.orderItems}" class="item-row">
                    <img th:if="${item.product?.mainImage != null}" th:src="@{'/upload/shop/' + ${item.product.mainImage}}" class="item-img">
                    <div class="item-info">
                        <div class="item-name">
                            <a th:if="${item.product != null}"
                               th:href="@{/dbShop/dbProductContent(id=${item.product.id})}"
                               th:text="${item.product.name}"
                               class="product-link">
                                ÏÉÅÌíàÎ™Ö
                            </a>
                            <span th:if="${item.product == null}" style="color: #999;">
                                (ÏÇ≠Ï†úÎêú ÏÉÅÌíà)
                            </span>
                        </div>
                        <div class="item-price">
                            <span th:text="${#numbers.formatInteger(item.orderPrice, 0, 'COMMA')} + 'Ïõê'"></span> |
                            <span th:text="${item.count} + 'Í∞ú'"></span>
                        </div>
                    </div>
                    <div th:if="${order.status != null and order.status.name() == 'CONFIRMED'}" style="display: flex; gap: 5px;">
                        <th:block th:if="${item.shopReview == null}">
                            <button type="button"
                                    class="btn-action btn-review"
                                    th:data-oid="${item.id}"
                                    th:data-pid="${item.product?.id}"
                                    th:data-pname="${item.product?.name}"
                                    onclick="openReviewModal(this.getAttribute('data-oid'), this.getAttribute('data-pid'), this.getAttribute('data-pname'), null)">
                                Î¶¨Î∑∞ÏûëÏÑ±
                            </button>
                        </th:block>
                        <th:block th:if="${item.shopReview != null}">
                            <button type="button" class="btn-action btn-modify"
                                    th:data-oid="${item.id}"
                                    th:data-pid="${item.product?.id}"
                                    th:data-pname="${item.product?.name}"
                                    th:data-rid="${item.shopReview?.id}"
                                    onclick="openReviewModal(this.getAttribute('data-oid'), this.getAttribute('data-pid'), this.getAttribute('data-pname'), this.getAttribute('data-rid'))">
                                Î¶¨Î∑∞ÏàòÏ†ï
                            </button>
                            <button type="button" class="btn-action btn-delete"
                                    th:data-rid="${item.shopReview?.id}"
                                    onclick="deleteReview(this.getAttribute('data-rid'))">
                                Î¶¨Î∑∞ÏÇ≠Ï†ú
                            </button>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
        <ul class="pagination" th:if="${result.totalPage > 0}">
            <li th:if="${result.prev}">
                <a th:href="@{/order/history(page=${result.start - 1}, keyword=${pageRequestDTO.keyword}, startDate=${startDate}, endDate=${endDate}, status=${searchStatus})}">&lt;</a>
            </li>
            <li th:each="pageNum : ${result.pageList}" th:classappend="${result.page == pageNum} ? 'active'">
                <a th:href="@{/order/history(page=${pageNum}, keyword=${pageRequestDTO.keyword}, startDate=${startDate}, endDate=${endDate}, status=${searchStatus})}">[[${pageNum}]]</a>
            </li>
            <li th:if="${result.next}">
                <a th:href="@{/order/history(page=${result.end + 1}, keyword=${pageRequestDTO.keyword}, startDate=${startDate}, endDate=${endDate}, status=${searchStatus})}">&gt;</a>
            </li>
        </ul>
    </div>
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="modalTitle">Î¶¨Î∑∞ ÏûëÏÑ±</h3>
            <p id="modalProductName" style="margin-bottom: 15px; font-weight: bold; color: #555;"></p>
            <form id="reviewForm">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                <input type="hidden" name="productId" id="modalProductId">
                <input type="hidden" name="orderItemId" id="modalOrderItemId">
                <input type="hidden" name="reviewId" id="modalReviewId">
                <input type="hidden" name="rating" id="ratingInput" value="5">
                <div>
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Î≥ÑÏ†ê</label>
                    <div class="star-rating" id="starContainer">
                        <span class="star filled" data-value="1">‚òÖ</span>
                        <span class="star filled" data-value="2">‚òÖ</span>
                        <span class="star filled" data-value="3">‚òÖ</span>
                        <span class="star filled" data-value="4">‚òÖ</span>
                        <span class="star filled" data-value="5">‚òÖ</span>
                    </div>
                </div>
                <div class="file-box">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">ÏÇ¨ÏßÑ Ï≤®Î∂Ä</label>
                    <input type="file" name="reviewFile" accept="image/*">
                    <p id="currentImageText">ÌòÑÏû¨ Îì±Î°ùÎêú Ïù¥ÎØ∏ÏßÄ ÏûàÏùå (ÌååÏùº ÏÑ†ÌÉù Ïãú Î≥ÄÍ≤ΩÎê®)</p>
                </div>
                <textarea name="content" id="reviewContent" class="form-textarea" placeholder="Î¶¨Î∑∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." required></textarea>
                <div style="text-align: right;">
                    <button type="button" class="btn-action" onclick="closeReviewModal()">Ï∑®ÏÜå</button>
                    <button type="button" id="btnSubmitReview" class="btn-action btn-confirm" onclick="submitReview()">Îì±Î°ù</button>
                </div>
            </form>
        </div>
    </div>
</main>

<div th:replace="~{include/footer :: footer}"></div>
<script th:inline="javascript">
    /*<![CDATA[*/
    const contextPath = /*[[@{/}]]*/ "/";

    const msg = /*[[${msg}]]*/ null;
    if (msg) {
        alert(msg);
    }
    /*]]>*/

    function checkDateRange() {
        const start = document.getElementById('startDate');
        const end = document.getElementById('endDate');

        if (start.value && end.value) {
            if (start.value > end.value) {
                alert("Ï¢ÖÎ£åÏùºÏùÄ ÏãúÏûëÏùºÎ≥¥Îã§ Îπ†Î•º Ïàò ÏóÜÏäµÎãàÎã§.");
                end.value = start.value;
            }
        }

        if (start.value) end.min = start.value;
        if (end.value) start.max = end.value;
    }

    document.addEventListener("DOMContentLoaded", function() {
        checkDateRange();
    });

    function openReviewModal(orderItemId, productId, productName, reviewId) {
        document.getElementById('modalProductId').value = productId;
        document.getElementById('modalOrderItemId').value = orderItemId;
        document.getElementById('modalReviewId').value = reviewId ? reviewId : '';
        document.getElementById('modalProductName').innerText = productName;

        const submitBtn = document.getElementById('btnSubmitReview');
        const modalTitle = document.getElementById('modalTitle');
        const imgText = document.getElementById('currentImageText');
        const contentArea = document.getElementById('reviewContent');

        if (reviewId) {
            modalTitle.innerText = "Î¶¨Î∑∞ ÏàòÏ†ï";
            submitBtn.innerText = "ÏàòÏ†ï";

            fetch(contextPath + 'shopReview/' + reviewId)
                .then(res => {
                    if(!res.ok) throw new Error("Î¶¨Î∑∞ Ï°∞Ìöå Ïã§Ìå®");
                    return res.json();
                })
                .then(data => {
                    contentArea.value = data.content;
                    resetStars(data.rating);
                    if(data.reviewImage) imgText.style.display = 'block';
                    else imgText.style.display = 'none';
                })
                .catch(err => {
                    console.error(err);
                    alert("Î¶¨Î∑∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                });
        } else {
            modalTitle.innerText = "Î¶¨Î∑∞ ÏûëÏÑ±";
            submitBtn.innerText = "Îì±Î°ù";
            contentArea.value = '';
            imgText.style.display = 'none';
            resetStars(5);
        }
        document.getElementById('reviewModal').style.display = 'flex';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
    }

    function submitReview() {
        const reviewId = document.getElementById('modalReviewId').value;
        const form = document.getElementById('reviewForm');

        if(!form.content.value.trim()) {
            alert("Î¶¨Î∑∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }

        const formData = new FormData(form);
        const url = reviewId ? contextPath + 'shopReview/modify' : contextPath + 'shopReview/registerAsync';

        fetch(url, { method: 'POST', body: formData })
            .then(response => {
                if (response.ok) {
                    alert(reviewId ? "Î¶¨Î∑∞Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§." : "Î¶¨Î∑∞Í∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
                    location.reload();
                } else {
                    return response.text().then(text => { throw new Error(text) });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Ï≤òÎ¶¨ Ïã§Ìå®: " + error.message);
            });
    }

    function deleteReview(reviewId) {
        if (!confirm("Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
        const csrfToken = document.querySelector('input[name="_csrf"]').value;

        fetch(contextPath + 'shopReview/delete/' + reviewId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: '_csrf=' + csrfToken
        })
            .then(response => {
                if (response.ok) {
                    alert("ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                    location.reload();
                } else {
                    return response.text().then(text => { throw new Error(text) });
                }
            })
            .catch(error => alert("ÏÇ≠Ï†ú Ïã§Ìå®: " + error.message));
    }

    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('ratingInput');
    let currentRating = 5;

    stars.forEach(star => {
        star.addEventListener('mouseover', function() { fillStars(parseInt(this.getAttribute('data-value'))); });
        star.addEventListener('click', function() {
            const val = parseInt(this.getAttribute('data-value'));
            currentRating = val;
            ratingInput.value = val;
            fillStars(val);
        });
    });

    document.getElementById('starContainer').addEventListener('mouseleave', function() { fillStars(currentRating); });

    function fillStars(val) {
        stars.forEach(s => {
            if (parseInt(s.getAttribute('data-value')) <= val) {
                s.classList.add('filled');
                s.style.color = '#ffd700';
            } else {
                s.classList.remove('filled');
                s.style.color = '#ddd';
            }
        });
    }

    function resetStars(val) {
        currentRating = val;
        ratingInput.value = val;
        fillStars(val);
    }
</script>
</body>
</html>