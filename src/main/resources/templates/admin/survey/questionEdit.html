<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>문항 작성</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>

<!-- Sidebar -->
<div th:replace="~{admin/adminLeft :: sidebar}"></div>

<main class="admin-content">

  <button class="btn btn-outline-secondary d-lg-none mb-3" onclick="toggleSidebar()">☰ 메뉴</button>

  <!-- Header -->
  <div class="mb-4">
    <h3 class="fw-bold" th:text="${q.id} != null ? '문항 수정' : '새 문항 추가'"></h3>
    <small class="text-secondary">질문 내용을 입력하고 유형을 선택합니다.</small>
  </div>


  <div class="card shadow-sm p-4" style="max-width:900px;">

    <form th:action="@{'/admin/survey/' + ${surveyId} + '/question/save'}" method="post">

      <input type="hidden" name="id" th:value="${q.id}">
      <input type="hidden" name="surveyId" th:value="${surveyId}">


      <!-- 질문 내용 -->
      <div class="mb-3">
        <label class="form-label">질문 내용</label>
        <input type="text" class="form-control"
               name="questionText"
               id="qText"
               placeholder="질문을 입력하세요 (예: 좋아하는 과일은 무엇인가요?)"
               th:value="${q.questionText}">
      </div>


      <!-- 질문 유형 선택 -->
      <div class="mb-3">
        <label class="form-label">질문 유형</label>
        <select class="form-select" name="questionType" id="qType">
          <option value="TEXT"   th:selected="${q.questionType?.name() == 'TEXT'}">주관식</option>
          <option value="SINGLE" th:selected="${q.questionType?.name() == 'SINGLE'}">단일 선택</option>
          <option value="MULTI"  th:selected="${q.questionType?.name() == 'MULTI'}">다중 선택</option>
          <option value="SELECT" th:selected="${q.questionType?.name() == 'SELECT'}">드롭다운 선택</option>
          <option value="RATING" th:selected="${q.questionType?.name() == 'RATING'}">평가 (1~5점)</option>
        </select>
      </div>


      <!-- 보기 옵션 영역 -->
      <div id="choiceBox" style="display:none;">
        <label class="form-label">
          보기 옵션
          <small id="choiceTip" class="text-muted"></small>
        </label>

        <div id="choiceList">
          <div th:each="c : ${choices}" class="input-group mb-2">
            <input type="text" class="form-control choice-input"
                   name="choiceTexts"
                   th:value="${c.choiceText}"
                   placeholder="예: 사과"
                   oninput="updatePreview()">
            <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)">삭제</button>
          </div>
        </div>

        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addChoice()">
          + 선택지 추가
        </button>
      </div>


      <hr>

      <!-- 미리보기 영역 -->
      <div class="card mt-4 mb-4 shadow-sm p-3">
        <h6 class="fw-bold">미리보기</h6>
        <div id="previewBox" class="mt-2"></div>
      </div>

      <!-- Submit Buttons -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">저장</button>

        <a th:href="@{'/admin/survey/' + ${surveyId} + '/questions'}"
           class="btn btn-secondary">
          취소
        </a>
      </div>

    </form>
  </div>

</main>


<!-- 스크립트 -->
<script>
  function toggleSidebar() {
    document.querySelector('.admin-sidebar').classList.toggle('active');
  }


  /* ===================== TYPE 변경 ====================== */
  document.getElementById('qType').addEventListener('change', function(){
    handleTypeChange();
    updatePreview();
    updateChoiceTooltip();
  });

  /* ===================== 질문 텍스트 변경 ====================== */
  document.getElementById('qText').addEventListener('input', updatePreview);


  /* ===================== 보기 옵션 Show/Hide ====================== */
  function handleTypeChange(){
    const type = document.getElementById('qType').value;
    const box = document.getElementById('choiceBox');

    if (type === 'SINGLE' || type === 'MULTI' || type === 'SELECT') {
      box.style.display = '';
    } else {
      box.style.display = 'none';
    }
  }


  /* ===================== 선택지 추가 ====================== */
  function addChoice(text="") {
    const list = document.getElementById("choiceList");

    const div = document.createElement("div");
    div.className = "input-group mb-2";

    div.innerHTML = `
      <input type="text"
             class="form-control choice-input"
             name="choiceTexts"
             placeholder="예: 사과"
             value="${text}"
             oninput="updatePreview()">

      <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)">삭제</button>
    `;

    list.appendChild(div);
    updatePreview();
  }


  /* ===================== 선택지 삭제 ====================== */
  function removeChoice(btn){
    btn.parentElement.remove();
    updatePreview();
  }


  /* ===================== Preview 생성 ====================== */
  function updatePreview(){
    const preview = document.getElementById("previewBox");
    const text = document.getElementById("qText").value.trim();
    const type = document.getElementById("qType").value;
    const choices = [...document.querySelectorAll(".choice-input")].map(i => i.value.trim()).filter(v => v.length > 0);

    preview.innerHTML = "";

    if (!text) {
      preview.innerHTML = "<span class='text-muted'>질문을 입력하면 미리보기가 표시됩니다.</span>";
      return;
    }

    const q = document.createElement("div");
    q.className = "fw-semibold mb-2";
    q.textContent = text;
    preview.appendChild(q);

    if (type === "TEXT") {
      preview.innerHTML += `<input type="text" class="form-control w-50" placeholder="답변 입력">`;
      return;
    }

    if (type === "RATING") {
      preview.innerHTML += `
        <div>
          ${[1,2,3,4,5].map(n => `
            <label class="me-2">
              <input type="radio" name="ratingPreview"> ${n}점
            </label>
          `).join("")}
        </div>
      `;
      return;
    }

    if (choices.length === 0) {
      preview.innerHTML += `<small class="text-muted">보기 옵션을 입력하세요</small>`;
      return;
    }

    if (type === "SINGLE") {
      preview.innerHTML += `
        ${choices.map(c => `
          <div class="form-check">
            <input type="radio" name="previewSingle" class="form-check-input">
            <label>${c}</label>
          </div>`).join("")}
      `;
      return;
    }

    if (type === "MULTI") {
      preview.innerHTML += `
        ${choices.map(c => `
          <div class="form-check">
            <input type="checkbox" class="form-check-input">
            <label>${c}</label>
          </div>`).join("")}
      `;
      return;
    }

    if (type === "SELECT") {
      preview.innerHTML += `
        <select class="form-select w-50">
          ${choices.map(c => `<option>${c}</option>`).join("")}
        </select>
      `;
      return;
    }
  }

  function updateChoiceTooltip() {
    const type = document.getElementById('qType').value;
    const tip = document.getElementById('choiceTip');

    if(type === 'SINGLE') {
      tip.textContent = "보기 옵션: 사용자는 이 중 하나만 선택할 수 있습니다 (라디오 버튼).";
    }
    else if(type === 'MULTI') {
      tip.textContent = "보기 옵션: 여러 개를 선택할 수 있습니다 (체크박스).";
    }
    else if(type === 'SELECT') {
      tip.textContent = "보기 옵션: 드롭다운 목록으로 표시됩니다.";
    }
    else if(type === 'RATING') {
      tip.textContent = "이 질문 유형은 1~5점 평가이며, 보기 옵션은 필요하지 않습니다.";
    }
    else if(type === 'TEXT') {
      tip.textContent = "사용자가 직접 텍스트 답변을 입력합니다. 보기 옵션은 필요 없습니다.";
    }
    else {
      tip.textContent = "";
    }
  }

  /* ===================== 초기 세팅 ====================== */
  document.addEventListener("DOMContentLoaded", () => {
    handleTypeChange();
    updatePreview();
    updateChoiceTooltip();
  });

</script>

</body>
</html>
