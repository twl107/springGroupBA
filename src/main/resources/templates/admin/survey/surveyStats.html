<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>ì„¤ë¬¸ í†µê³„</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" th:href="@{/css/admin.css}">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .question-title {
      font-size: 18px;
      font-weight: 600;
    }

    .divider {
      border-top: 1px solid #ddd;
      margin: 25px 0;
    }
  </style>

</head>

<body>

<!-- Sidebar -->
<div th:replace="~{admin/adminLeft :: sidebar}"></div>

<main class="admin-content">
  <button class="btn btn-outline-secondary d-lg-none mb-3" onclick="toggleSidebar()">â˜° ë©”ë‰´</button>

  <!-- Header -->
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h3 class="fw-bold mb-1" th:text="${surveyMeta.title}">ì„¤ë¬¸ ì œëª©</h3>
      <small class="text-secondary">ID:
        <span class="fw-semibold" th:text="${surveyId}"></span>
      </small>
    </div>

    <a th:href="@{'/admin/survey'}" class="btn btn-outline-secondary">
      â† ëª©ë¡ìœ¼ë¡œ
    </a>
  </div>


  <div class="card shadow-sm p-4">

    <div th:each="stat, iter : ${statsList}" class="mb-4">

      <!-- ì§ˆë¬¸ ì œëª© -->
      <h5 class="question-title">
        <span th:text="${iter.index + 1} + '.'"></span>
        <span th:text="${stat.questionText}"></span>
      </h5>

      <small class="text-secondary">ì‘ë‹µ ìˆ˜:
        <span th:text="${stat.totalResponses}"></span>
      </small>
      <hr class="my-2">


      <!-- =====================
         SINGLE / MULTI / SELECT
         ===================== -->
      <div th:if="${stat.type.name() == 'SINGLE'
              or stat.type.name() == 'MULTI'
              or stat.type.name() == 'SELECT'}">

        <!-- í‘œ -->
        <table class="table table-sm align-middle mb-3">
          <thead class="table-light">
          <tr>
            <th style="width:60%">í•­ëª©</th>
            <th style="width:40%" class="text-end">ë¹„ìœ¨</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="entry : ${stat.percentMap.entrySet()}">
            <td th:text="${entry.key}"></td>
            <td class="text-end">
              <span th:text="${entry.value}"></span>%
            </td>
          </tr>
          </tbody>
        </table>

        <!-- ì°¨íŠ¸ -->
        <canvas th:attr="id=${'chart_' + iter.index}" height="60"></canvas>
      </div>


      <!-- =====================
         TEXT ì‘ë‹µ
         ===================== -->
      <div th:if="${stat.type.name() == 'TEXT'}">

        <div class="fw-semibold mb-2">ğŸ’¬ ììœ  ì‘ë‹µ ëª©ë¡</div>

        <div th:each="t : ${stat.textResponses}" class="p-2 mb-1 border rounded bg-light">
          <span th:text="${t}"></span>
        </div>
      </div>


      <!-- =====================
        RATING
        ===================== -->
      <div th:if="${stat.type.name() == 'RATING'}">

        <div class="fw-semibold mb-2">â­ í‰ê·  ë§Œì¡±ë„</div>

        <p class="mt-2 fs-5">
          <strong>í‰ê·  : </strong>
          <span th:text="${stat.avg}"></span> ì 
        </p>

      </div>


      <!-- êµ¬ë¶„ì„  -->
      <div class="divider"></div>

    </div>

  </div>



  <!-- Chart.js Script -->
  <script th:inline="javascript">
    /*<![CDATA[*/

    let statsData = [[${ statsList }]];

    // ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (10ê°œ)
    const colorPalette = [
      '#00b894', '#0984e3', '#6c5ce7',
      '#fdcb6e', '#e17055', '#d63031',
      '#2d3436', '#55efc4', '#74b9ff', '#a29bfe'
    ];

    statsData.forEach((stat, idx) => {

      if (stat.type === 'RATING') {
        return;
      }

      console.log("==== STAT DEBUG ====");
      console.log(stat);
      console.log("TYPE:", stat.type);
      console.log("COUNT MAP:", stat.countMap);

      /* ===========================
         SINGLE / MULTI / SELECT  (ë¹„ìœ¨ ì°¨íŠ¸)
      ============================ */
      if (stat.percentMap && Object.keys(stat.percentMap).length > 0) {

        let labels = Object.keys(stat.percentMap);
        let values = Object.values(stat.percentMap);

        // í•­ëª©ë³„ ìƒ‰ìƒ ìë™ ë°°ì • (ìˆœí™˜)
        let bgColors = labels.map((_, i) =>
          colorPalette[i % colorPalette.length]
        );

        let ctx = document.getElementById("chart_" + idx);

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              borderWidth: 1,
              backgroundColor: bgColors,
              hoverBackgroundColor: bgColors
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      }
    });
    /*]]>*/
  </script>

</main>

<script>
  function toggleSidebar() {
    document.querySelector('.admin-sidebar').classList.toggle('active');
  }
</script>

</body>

</html>