<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security6">
<head>
    <meta charset="UTF-8">
    <title>ê·¸ë¦°ì†Œí”„íŠ¸ - ìë£Œì‹¤</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/pds.css}">
</head>
<body>

<div th:replace="~{include/header :: header}"></div>
<main class="main-content">
    <section class="sub-visual" th:style="'background-image: url(' + @{/images/content/img_visual01.jpg} + ');'">
        <div class="sub-visual-content">
            <h2>ìë£Œì‹¤</h2>
        </div>
    </section>
    <div class="sub-content-container">
        <div class="pds-form-container">
            <div class="view-header">
                <h3 class="view-title">[[${dto.title}]]</h3>
                <div class="view-meta">
                    <span>ğŸ‘¤ [[${dto.writerName}]]</span>
                    <span th:if="${dto.regDate != null}">ğŸ“… [[${#temporals.format(dto.regDate, 'yyyy-MM-dd HH:mm')}]]</span>
                    <span>ğŸ‘ï¸ [[${dto.readNum}]]</span>
                </div>
            </div>
            <div class="view-content">[[${dto.content}]]</div>
            <div class="view-files" th:if="${dto.fileCount > 0}">
                <h4 style="font-size: 0.95rem; margin-bottom: 8px; color: #333;">ğŸ’¾ ì²¨ë¶€íŒŒì¼</h4>
                <div th:each="file : ${dto.files}" style="margin-bottom: 3px;">
                    <a th:href="@{/pds/download/{id}(id=${file.id})}" class="file-link" style="display: flex; align-items: center; gap: 5px;">
                        ğŸ“„ <span th:text="${file.originalFileName}"></span>
                        <span style="color: #888; font-size: 0.8rem;">([[${file.fileSizeStr}]])</span>
                    </a>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 30px; margin-top: 30px;">
                <div style="display: inline-flex; gap: 15px; align-items: center;">
                    <a th:href="@{/pds/vote/{id}(id=${dto.id}, type='good')}" style="text-decoration: none; text-align: center; cursor: pointer; border: 1px solid #007bff; padding: 8px 20px; border-radius: 50px; transition: 0.3s;">
                        <span style="font-size: 1.2rem;">ğŸ‘</span> <span style="font-weight: bold; color: #007bff; font-size: 1.1rem; margin-left: 5px;">[[${dto.good}]]</span>
                    </a>
                    <a th:href="@{/pds/vote/{id}(id=${dto.id}, type='bad')}" style="text-decoration: none; text-align: center; cursor: pointer; border: 1px solid #dc3545; padding: 8px 20px; border-radius: 50px; transition: 0.3s;">
                        <span style="font-size: 1.2rem;">ğŸ‘</span> <span style="font-weight: bold; color: #dc3545; font-size: 1.1rem; margin-left: 5px;">[[${dto.bad}]]</span>
                    </a>
                </div>
            </div>
            <div class="btn-area" style="margin-bottom: 40px; border-top:none;">
                <a th:href="@{/pds/pdsList(page=${requestDTO.page}, type=${requestDTO.type}, keyword=${requestDTO.keyword})}" class="btn-cancel">ëª©ë¡</a>
                <th:block sec:authorize="isAuthenticated()" th:if="${#authentication.name == dto.writerEmail or #authorization.expression('hasRole(''ADMIN'')')}">
                    <a th:href="@{/pds/pdsUpdate(id=${dto.id}, page=${requestDTO.page}, type=${requestDTO.type}, keyword=${requestDTO.keyword})}" class="btn-submit">ìˆ˜ì •</a>
                    <form th:action="@{/pds/delete}" method="post" style="display:inline;" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="id" th:value="${dto.id}">
                        <button type="submit" class="btn-cancel" style="background-color: #dc3545; color: white; border: none;">ì‚­ì œ</button>
                    </form>
                </th:block>
            </div>
            <div class="reply-section">
                <div class="reply-count">ğŸ’¬ ëŒ“ê¸€ ([[${#lists.size(replyList)}]])</div>
                <div class="reply-form-box">
                    <form th:action="@{/pds/reply/register}" method="post">
                        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="pdsId" th:value="${dto.id}">
                        <textarea name="content" class="reply-textarea" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”." required></textarea>
                        <div class="reply-form-footer">
                            <button type="submit" class="btn-reply-submit">ë“±ë¡</button>
                        </div>
                    </form>
                </div>
                <div class="reply-list" style="margin-top: 20px;">
                    <div th:each="reply : ${replyList}"
                         class="reply-item"
                         th:classappend="${reply.depth > 0} ? 'is-child' : ''"
                         th:style="'padding-left: ' + (${reply.depth} * 30) + 'px;'">
                        <div class="reply-container">
                            <div class="reply-line" th:if="${reply.depth > 0}"></div>
                            <div class="reply-avatar">
                                <img th:if="${reply.photoName != null and reply.photoName != 'noimage.jpg'}"
                                     th:src="@{'/upload/member/' + ${reply.photoName}}"
                                     alt="user"
                                     style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
                                <img th:unless="${reply.photoName != null and reply.photoName != 'noimage.jpg'}"
                                     src="https://placehold.co/45x45/e9ecef/666666?text=U"
                                     alt="user"
                                     style="width: 45px; height: 45px; border-radius: 50%;">
                            </div>
                            <div class="reply-body">
                                <div class="reply-header">
                                    <div class="reply-info">
                                        <span class="reply-writer" th:text="${reply.writerName}">ì‘ì„±ì</span>
                                        <span class="reply-date">
                                            [[${#temporals.format(reply.modDate, 'yyyy-MM-dd HH:mm')}]]
                                            <span th:if="${reply.regDate != reply.modDate}" style="font-size:0.8em; color:#aaa;">(ìˆ˜ì •ë¨)</span>
                                        </span>
                                    </div>
                                </div>
                                <div class="reply-content-view">
                                    <div class="reply-text" th:if="${reply.isRemoved}" style="color: #999; font-style: italic;">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</div>
                                    <div class="reply-text" th:unless="${reply.isRemoved}" th:text="${reply.content}"></div>
                                </div>
                                <div class="reply-edit-form" style="display: none;">
                                    <form th:action="@{/pds/reply/update}" method="post">
                                        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="id" th:value="${reply.id}">
                                        <input type="hidden" name="pdsId" th:value="${dto.id}">
                                        <textarea name="content" class="reply-textarea" style="border:1px solid #007bff; background:#fff;" required>[[${reply.content}]]</textarea>
                                        <div class="reply-form-footer" style="justify-content: flex-start; gap: 10px;">
                                            <button type="submit" class="btn-reply-submit">ìˆ˜ì •ì™„ë£Œ</button>
                                            <button type="button" class="btn-sm" onclick="toggleEditForm(this)">ì·¨ì†Œ</button>
                                        </div>
                                    </form>
                                </div>
                                <div class="reply-actions" th:unless="${reply.isRemoved}">
                                    <button type="button" class="action-btn" onclick="toggleNestedReplyForm(this)">ğŸ’¬ ë‹µê¸€</button>
                                    <div class="ml-auto" style="display: flex; gap: 10px;">
                                        <th:block sec:authorize="isAuthenticated()" th:if="${#authentication.name == dto.writerEmail or #authorization.expression('hasRole(''ADMIN'')')}">
                                            <button type="button" class="action-btn" onclick="toggleEditForm(this)">âœï¸ ìˆ˜ì •</button>
                                            <form th:action="@{/pds/reply/delete}" method="post" style="display:inline;">
                                                <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                <input type="hidden" name="replyId" th:value="${reply.id}">
                                                <input type="hidden" name="pdsId" th:value="${dto.id}">
                                                <button type="submit" class="action-btn delete" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ğŸ—‘ï¸ ì‚­ì œ</button>
                                            </form>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="nested-reply-box">
                            <form th:action="@{/pds/reply/register}" method="post">
                                <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <input type="hidden" name="pdsId" th:value="${dto.id}">
                                <input type="hidden" name="parentId" th:value="${reply.id}">
                                <textarea name="content" class="reply-textarea" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." required style="background: #fff;"></textarea>
                                <div class="reply-form-footer">
                                    <button type="submit" class="btn-reply-submit">ë‹µê¸€ ë“±ë¡</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{include/footer :: footer}"></div>
<th:block th:replace="~{include/messageScript :: alertFragment}"></th:block>

<script th:inline="javascript">
    /*<![CDATA[*/
    const contextPath = /*[[@{/}]]*/ "/";
    /*]]>*/

    function toggleNestedReplyForm(btn) {
        const item = btn.closest('.reply-item');
        const formBox = item.querySelector('.nested-reply-box');
        if (formBox.style.display === 'block') {
            formBox.style.display = 'none';
            btn.innerText = 'ğŸ’¬ ë‹µê¸€';
            btn.style.color = '#888';
        } else {
            formBox.style.display = 'block';
            btn.innerText = 'âŒ ë‹«ê¸°';
            btn.style.color = '#333';
        }
    }
    function toggleEditForm(btn) {
        const item = btn.closest('.reply-body');
        const viewDiv = item.querySelector('.reply-content-view');
        const editDiv = item.querySelector('.reply-edit-form');
        if (editDiv.style.display === 'none') {
            viewDiv.style.display = 'none';
            editDiv.style.display = 'block';
        } else {
            viewDiv.style.display = 'block';
            editDiv.style.display = 'none';
        }
    }
</script>

</body>
</html>